# 八角志（微信小程序 + 后台管理）设计文档

## 1. 项目目标
打造面向格斗爱好者的内容与数据平台「八角志」，提供以下核心能力：
- 最新格斗资讯
- 赛事赛程与战卡详情
- 选手资料与动态
- 赛前分析预测（后续扩展位）

本阶段仅设计与规划：微信小程序（用户端）+ 管理后台（运营端）+ 服务端支撑架构。

## 2. MVP 范围（已确认）
### 2.1 首版包含
- 资讯：自动抓取为主，进入审核池后发布
- 赛事：UFC / ONE / PFL / Bellator 的赛程与战卡
- 选手：基础资料与最近动态
- 赛事进行中赛果更新：每 30 秒刷新

### 2.2 首版不包含
- 用户登录/收藏/关注/推送
- 拼音/别名检索（仅名称包含匹配）
- 全自动无审核发布

## 3. 产品交互设计
### 3.1 小程序端
- 首页：资讯流（标题、摘要、来源、发布时间）
- 赛事页：仅展示赛程列表（可按赛事组织、日期筛选）
- 赛事详情页：展示战卡详情（主赛/副赛、状态、结果）
- 选手详情页：展示选手资料与最近动态
- 选手搜索：可独立搜索选手名称（包含匹配），无需先进入赛事链路

核心链路：
1. 赛事列表 -> 赛事详情（战卡） -> 点击选手 -> 选手详情
2. 选手搜索 -> 选手详情

### 3.2 后台管理端
- 仪表盘：抓取成功率、待审核数、今日发布数
- 来源管理：抓取源配置、抓取频率、启停控制、异常告警阈值
- 内容审核：待审核列表、通过/驳回、批量处理
- 资讯管理：发布、下线、置顶、标签
- 赛事管理：赛程维护、战卡维护、赛果修正
- 选手管理：资料编辑、动态维护、赛事关联
- 系统管理：账号角色与操作日志

## 4. 技术架构（方案 2）
采用「模块化单体 + 抓取任务队列」：
- 小程序：微信原生小程序
- 管理后台：Vue 3
- 后端：Go 单体 API（模块化边界）
- 队列与缓存：Redis
- 数据库：MySQL

后端模块建议：
- content（资讯）
- event（赛事/战卡/赛果）
- fighter（选手）
- ingest（抓取入口与来源）
- review（审核流）
- admin（后台权限与日志）

部署建议：
- 首版单机多进程（API + Worker）+ MySQL + Redis
- 后续可独立横向扩容 Worker

## 5. 数据流与状态机
### 5.1 抓取与发布流
1. 定时器生成抓取任务
2. 任务入 Redis 队列
3. Worker 消费并抓取
4. 原始记录入库并去重
5. 生成待审核记录
6. 后台审核通过后发布
7. 小程序 API 返回已发布数据

### 5.2 赛事实时更新流（30 秒）
1. 赛事状态为 live 时加入高频更新任务
2. Worker 每 30 秒拉取战卡结果
3. 幂等更新 bout_result（胜负/方式/回合/时间）
4. 刷新赛事详情缓存
5. 小程序拉取最新战卡显示

### 5.3 状态机
- 赛事：scheduled -> live -> completed
- 对阵：pending -> finished
- 资讯：draft -> pending_review -> published/rejected -> archived

## 6. 合规与展示策略
资讯展示策略：
- 小程序仅展示「标题 + 摘要 + 来源链接」
- 不展示来源原文全文

合规理由：
- 降低版权与转载风险
- 保留来源归属与追溯能力

## 7. 稳定性与异常处理
- 抓取失败：指数退避重试 + 死信队列
- 解析失败：记录样本并标记来源需修复
- 去重键：source_url + title_hash + publish_time
- 幂等写入：防止赛果重复更新引发脏数据
- 实时降级：连续失败自动从 30 秒降级到 60 秒并告警
- 前端透明：显示“最近更新时间”
- 审计：后台关键操作全日志化

## 8. 测试与验收标准
### 8.1 测试
- 后端单元测试：解析、去重、状态流转、幂等更新
- 后端集成测试：抓取-审核-发布链路，live 更新链路
- 小程序联调测试：赛事列表 -> 战卡详情 -> 选手详情
- 管理后台测试：审核发布、赛果修正、权限控制

### 8.2 MVP 验收
- 自动抓取内容可进入审核池并发布到小程序
- 赛事页展示赛程，点进显示战卡
- 战卡点击选手可查看选手资料与动态
- 进行中赛事每 30 秒更新赛果并正确展示
- 用户可独立搜索选手名称并查看资料动态

## 9. 里程碑建议
- M1：基础架构 + 资讯抓取/审核/发布闭环
- M2：赛事赛程与战卡详情 + live 更新
- M3：选手资料、动态、选手搜索
- M4：稳定性优化与上线准备（监控、告警、压测）

## 10. 后续实现计划
下一步进入实现规划文档（writing-plans），产出任务化、可执行、可验收的开发计划。
